# 问题修复说明

## 发现的问题

在批量测试中，发现MILP求解器的结果比暴力枚举法（理论上应该找到最优解）的结果还要好，这是不合理的。

### 问题原因

**根本原因**：暴力枚举法在枚举所有可能的建设决策 `z` 时，对每个 `z` 使用**贪心方法**来求解用户分配 `x` 和 `y`。贪心方法不能保证找到最优解，因此暴力枚举法实际上并没有找到真正的全局最优解。

具体来说：
1. 暴力枚举法枚举了所有 `2^m` 种可能的 `z` 组合 ✓
2. 但对于每个 `z`，它使用贪心方法求解 `x` 和 `y` ✗
3. MILP使用线性规划同时优化 `z`, `x`, `y`，能找到真正的全局最优解 ✓

因此，MILP的结果更优是**正确的**，问题在于暴力枚举法的实现不正确。

## 修复方案

### 修复暴力枚举法 (`solvers/brute_force.py`)

修改 `_solve_given_z()` 方法：
- **之前**：使用贪心方法求解给定 `z` 的 `x` 和 `y`
- **现在**：使用线性规划（LP）求解给定 `z` 的 `x` 和 `y`

具体实现：
1. 添加 `_solve_given_z_lp()` 方法：使用PuLP求解线性规划子问题
2. 添加 `_solve_given_z_greedy()` 方法：作为备选（当PuLP不可用时）
3. `_solve_given_z()` 方法自动选择使用LP（如果可用）或贪心方法

### 修复后的效果

修复后，对于小规模问题（m ≤ 15），暴力枚举法现在能够找到真正的全局最优解，与MILP的结果一致。

测试验证：
- P1_S1: 暴力枚举 = MILP = 1167.50 ✓
- P1_S7: 暴力枚举 = MILP = 2591.68 ✓（之前暴力枚举 = 2487.24，MILP = 2591.68）

## 技术细节

### 子问题的线性规划模型

对于给定的建设决策 `z`，用户分配子问题是一个线性规划问题：

**决策变量**：
- `x_j`: 区域 `j` 的充电桩数量
- `y_{ij}`: 楼栋 `i` 分配到区域 `j` 的用户数

**目标函数**：
$$\max \sum_{i} \sum_{j} p_i \cdot y_{ij}$$

（注意：`\sum_j c_j \cdot z_j` 是常数，不影响子问题的优化）

**约束条件**：
1. `y_{ij} \leq D_i \cdot a_{ij} \cdot z_j` （覆盖关系）
2. `\sum_j y_{ij} \leq D_i` （需求约束）
3. `\sum_i y_{ij} \leq x_j` （容量约束）
4. `0 \leq x_j \leq U_j \cdot z_j` （容量上限）

## 注意事项

1. **性能影响**：使用LP求解子问题会增加计算时间，但保证了最优性
2. **依赖要求**：需要安装PuLP库。如果未安装，会自动降级到贪心方法
3. **适用规模**：暴力枚举法仍然仅适用于小规模问题（m ≤ 15）

## 相关文件

- `solvers/brute_force.py`: 修复的暴力枚举法
- `batch_test_results.csv`: 批量测试结果（需要重新运行生成）

## 验证

运行以下命令验证修复：
```bash
python3 debug_solver.py
```

应该看到暴力枚举法和MILP的结果完全一致（对于小规模问题）。
